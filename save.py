from mitmproxy.net.http.http1.assemble import assemble_request, assemble_response
from mitmproxy import ctx, proxy, options
import time
import asyncio
import os
import signal
from mitmproxy.tools.dump import DumpMaster
from mitmproxy.http import HTTPFlow

class AddApk:
    def __init__(self):
        self.name = ""

    def load(self, loader):
        loader.add_option(
            name = "output",
            typespec = str,
            default = "",
            help = "Specify the apk name",
        )
    def running(self):
        self.name = ctx.options.output
        f = open("output/" + self.name + "-mitmproxy.txt", 'w')

    def response(self, flow):
        f = open("output/" + self.name + "-mitmproxy.txt", 'a')
        f.write(assemble_request(flow.request).decode('utf-8'))

    def done(self):
        f.close()

addons = [
    AddApk()
]